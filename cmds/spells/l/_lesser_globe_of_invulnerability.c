#include <spell.h>
#include <daemons.h>
#include <magic.h>
inherit SPELL;

int query_inv_power()
{
    return 3;
}

void create()
{
    ::create();
    set_spell_name("lesser globe of invulnerability");
    set_spell_level(([ "mage" : 4, "magus" : 4, "cleric" : 4 ]));
    set_spell_sphere("abjuration");
    set_domains(({"protection"}));
    set_syntax("cast CLASS lesser globe of invulnerability");
    set_description("With this spell, you surround yourself with anti-magic field that disrupts intrinsic connections in the weave, briefly preventing spells of level 3 or less from entering the globe around you.");
    set_verbal_comp();
    set_somatic_comp();
    set_helpful_spell(1);
    set_components(([
      "mage" : ([ "small diamond" : 1, ]),
    ]));
}

int preSpell()
{
   if((int)CASTER->query_property("spell invulnerability"))
   {
      tell_object(CASTER,"You are already under the influence of similar effect.");
      return 0;
   }
   return 1;
}

void spell_effect()
{
    int duration;
    tell_object(caster, "%^WHITE%^%^BOLD%^The air around you starts to %^WHITE%^s%^RESET%^h%^BOLD%^i%^RESET%^m%^BOLD%^m%^RESET%^e%^BOLD%^r, as intrinsic magic fields are disrupted by your will.%^RESET%^");
    tell_room(place,"%^WHITE%^%^BOLD%^%^WHITE%^A %^MAGENTA%^g%^RESET%^%^MAGENTA%^l%^BOLD%^o%^RESET%^%^MAGENTA%^b%^BOLD%^e %^WHITE%^o%^RESET%^f %^BOLD%^%^CYAN%^s%^RESET%^%^CYAN%^h%^BOLD%^i%^RESET%^%^CYAN%^m%^BOLD%^m%^RESET%^%^CYAN%^e%^BOLD%^r %^WHITE%^encases "+caster->QCN+"%^RESET%^",caster);
    spell_successful();
    addSpellToCaster();
    caster->set_property("added short", ({ "%^BOLD%^%^WHITE%^ (%^CYAN%^inside a shimmering bubble%^WHITE%^)%^RESET%^" }));
    duration = clevel/4+1;
    duration = duration<5?5:duration;
    caster->set_property("spell invulnerability",query_inv_power());
    spell_duration = duration * ROUND_LENGTH;
    set_end_time();
    call_out("dest_effect",spell_duration);
}

void dest_effect(){
    if (objectp(caster)) {
        tell_object(caster, "%^BOLD%^%^MAGENTA%^The %^CYAN%^globe %^MAGENTA%^of %^CYAN%^force %^MAGENTA%^that surrounds you %^RESET%^%^MAGENTA%^fades.%^WHITE%^");
        tell_room(environment(caster), "%^BOLD%^%^MAGENTA%^The %^CYAN%^globe %^MAGENTA%^of %^CYAN%^force %^MAGENTA%^that surrounds " + caster->QCN + " %^RESET%^%^MAGENTA%^fades.%^WHITE%^", caster);
        caster->remove_property_value("added short", ({ "%^BOLD%^%^WHITE%^ (%^CYAN%^inside a shimmering bubble%^WHITE%^)%^RESET%^" }));
        caster->remove_property("spell invulnerability");
    }
    ::dest_effect();
    if(objectp(TO))
        TO->remove();
}
